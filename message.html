<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Messages</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .tabs { display: flex; background: #f1f1f1; }
    .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; }
    .tab.active { background: #ddd; font-weight: bold; }
    .messages { padding: 10px; }
    .message-item { display: flex; justify-content: space-between; align-items: center;
                    border-bottom: 1px solid #eee; padding: 8px; }
    .message-item.unread { background: #f9f9f9; font-weight: bold; }
    .profile { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .red-circle { background: red; color: #fff; border-radius: 50%; padding: 2px 6px;
                  font-size: 12px; margin-left: 5px; }
    .chat-box { display: none; height: 80vh; flex-direction: column; }
    .chat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #ccc; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 10px; }
    .chat-input { display: flex; border-top: 1px solid #ccc; }
    .chat-input input { flex: 1; padding: 10px; border: none; }
    .chat-input button { padding: 10px; }
    .popup { position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%);
             background: white; padding: 20px; border: 1px solid #ccc; display: none; z-index: 1000; }
    .popup button { margin-top: 10px; }
  </style>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="back-bar">
  <button id="backBtn">⬅ Back</button>
</div>

  <h2>Messages</h2>
  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" id="acceptedTab">Accepted <span id="acceptedCount" class="red-circle">0</span></div>
    <div class="tab" id="requestsTab">Requests <span id="requestCount" class="red-circle">0</span></div>
    <div class="tab" id="blockedTab">Blocked</div>
  </div>

  <!-- Messages List -->
  <div class="messages" id="messagesList"></div>

  <!-- Chat Box -->
  <div class="chat-box" id="chatBox">
    <div class="chat-header">
      <span id="chatUserName"></span>
      <div>
        <span id="creditsBox" style="border:1px solid #333;padding:5px;cursor:pointer;">Credits: <span id="creditValue">0</span></span>
        <button id="menuBtn">⋮</button>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Popup for Credits -->
  <div class="popup" id="creditsPopup">
    <h3>Credits Info</h3>
    <p>Each message costs 1 credit. Sending images may cost more.</p>
    <button id="buyCreditsBtn">Buy Credits</button>
    <button onclick="closePopup('creditsPopup')">× Close</button>
  </div>

  <!-- Popup for Low Credits -->
  <div class="popup" id="lowCreditsPopup">
    <p>Your credits are low. Please buy more to continue chatting.</p>
    <button id="buyCreditsBtn2">Buy Credits</button>
    <button onclick="closePopup('lowCreditsPopup')">× Close</button>
  </div>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
      <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyAJUpbCOWRl_YU14eAjARPacD9CuiBSPfg",
      authDomain: "probso.firebaseapp.com",
      projectId: "probso",
      storageBucket: "probso.firebasestorage.app",
      messagingSenderId: "892196080965",
      appId: "1:892196080965:web:9459195d61c71ed22a022c"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
  
    
    let currentUser = null;
    let credits = 0;
    let currentChatUser = null;

    // Firebase Auth Listener
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loadCredits();
        loadMessages("accepted"); // default tab
      }
    });
    
    firebase.auth().onAuthStateChanged((user) => {
    if (!user) {
        alert('Login required to view messages!');
        window.location.href = 'index.html'; // ya redirect to home
    }
});

    // Tabs
    document.getElementById("acceptedTab").addEventListener("click", () => switchTab("accepted"));
    document.getElementById("requestsTab").addEventListener("click", () => switchTab("requests"));
    document.getElementById("blockedTab").addEventListener("click", () => switchTab("blocked"));

    function switchTab(tab) {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.getElementById(tab + "Tab").classList.add("active");
      loadMessages(tab);
    }

    // Load Credits
    function loadCredits() {
      firebase.database().ref("users/" + currentUser.uid + "/credits").on("value", snap => {
        credits = snap.val() || 10; // default 10 credits
        document.getElementById("creditValue").innerText = credits;
      });
    }

    // Load Messages by Tab
    function loadMessages(tab) {
      const list = document.getElementById("messagesList");
      list.innerHTML = "<p>Loading...</p>";

      firebase.database().ref(tab + "/" + currentUser.uid).on("value", snap => {
        list.innerHTML = "";
        snap.forEach(child => {
          let data = child.val();
          let div = document.createElement("div");
          div.className = "message-item " + (data.unread ? "unread" : "");
          div.innerHTML = `
            <img src="${data.profile || 'default.png'}" class="profile">
            <div style="flex:1;">${data.name}</div>
            <small>${data.time || ''}</small>
          `;
          div.addEventListener("click", () => openChat(child.key, data));
          list.appendChild(div);
        });
      });
    }

    // Open Chat
    function openChat(uid, data) {
      currentChatUser = uid;
      document.getElementById("messagesList").style.display = "none";
      document.getElementById("chatBox").style.display = "flex";
      document.getElementById("chatUserName").innerText = data.name;

      loadChatMessages(uid);
    }

    function loadChatMessages(uid) {
      firebase.database().ref("messages/" + getChatId(uid)).on("value", snap => {
        const chatDiv = document.getElementById("chatMessages");
        chatDiv.innerHTML = "";
        snap.forEach(msg => {
          let m = msg.val();
          let p = document.createElement("p");
          p.textContent = m.senderName + ": " + m.text;
          chatDiv.appendChild(p);
        });
      });
    }

    // Send Message
    document.getElementById("sendBtn").addEventListener("click", () => {
      const text = document.getElementById("chatInput").value.trim();
      if (!text) return;

      if (credits <= 0) {
        openPopup("lowCreditsPopup");
        return;
      }

      let chatId = getChatId(currentChatUser);
      let msgRef = firebase.database().ref("messages/" + chatId).();
      msgRef.set({
        sender: currentUser.uid,
        senderName: currentUser.displayName,
        text: text,
        time: Date.now()
      });

      // Deduct credit
      firebase.database().ref("users/" + currentUser.uid + "/credits").set(credits - 1);

      document.getElementById("chatInput").value = "";
    });

    // Helper to get chat ID
    function getChatId(otherUid) {
      return currentUser.uid < otherUid ? currentUser.uid + "_" + otherUid : otherUid + "_" + currentUser.uid;
    }

    // Credits Popup
    document.getElementById("creditsBox").addEventListener("click", () => openPopup("creditsPopup"));
    document.getElementById("buyCreditsBtn").addEventListener("click", buyCredits);
    document.getElementById("buyCreditsBtn2").addEventListener("click", buyCredits);

    function openPopup(id) {
      document.getElementById(id).style.display = "block";
    }
    function closePopup(id) {
      document.getElementById(id).style.display = "none";
    }

    // Razorpay Buy Credits
    function buyCredits() {
      var options = {
        "key": "rzp_test_ROuGtblcgOSDnb",
        "amount": 10000, // 100 INR
        "currency": "INR",
        "name": "MyApp",
        "description": "Buy Credits",
        "handler": function (response){
          let newCredits = credits + 50; // add 50 credits
          firebase.database().ref("users/" + currentUser.uid + "/credits").set(newCredits);
          closePopup("creditsPopup");
          closePopup("lowCreditsPopup");
        }
      };
      var rzp1 = new Razorpay(options);
      rzp1.open();
    }
  </script>
 <script type="module">
  import { db, auth } from "./app.js";
</script>
</body>
</html>