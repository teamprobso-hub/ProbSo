<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f6f9; }
    .profile-container { max-width:600px; margin:10px auto; padding:20px; }
    .card { background:white; border-radius:12px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
    .profile-header { display:flex; align-items:center; gap:20px; }
    .profile-pic { width:100px; height:100px; border-radius:50%; border:3px solid #2196f3; object-fit:cover; }
    .stats { display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; text-align:center; margin-top:10px; }
    .stats div { font-weight:bold; }
    h3 { color:#2196f3; margin-bottom:10px; }
    .about p, .links p { margin:5px 0; }
    .actions { text-align:center; margin-top:20px; }
    .btn { padding:10px 20px; border:none; border-radius:8px; cursor:pointer; margin:5px; }
    .btn-primary { background:#2196f3; color:white; }
    .btn-secondary { background:#f0f0f0; }
    #editForm { display:none; margin-top:20px; }
    #editForm input, #editForm textarea { width:100%; padding:8px; margin:6px 0; border:1px solid #ccc; border-radius:6px; }
  </style>
</head>
<body>
  <div class="profile-container">
    <!-- Profile Card -->
    <div class="card">
      <div class="profile-header">
        <img id="profilePic" class="profile-pic" src="" alt="Profile Picture">
        <div>
          <h2 id="profileName">User Name</h2>
          <small id="points">0 Points</small>
        </div>
      </div>
      <div class="stats">
        <div><span id="followers">0</span><br>Followers</div>
        <div><span id="following">0</span><br>Following</div>
        <div><span id="posts">0</span><br>Posts</div>
        <div><span id="userPoints">0</span><br>Points</div>
      </div>
    </div>

    <!-- About -->
    <div class="card about">
      <h3>About Me</h3>
      <p><strong>Age:</strong> <span id="age"></span></p>
      <p><strong>Gender:</strong> <span id="gender"></span></p>
      <p><strong>Identity:</strong> <span id="identity"></span></p>
      <p><strong>Address:</strong> <span id="address"></span></p>
      <p><strong>Bio:</strong> <span id="bio"></span></p>
    </div>

    <!-- Links -->
    <div class="card links">
      <h3>Links</h3>
      <p id="links"></p>
    </div>

    <!-- Action buttons -->
    <div class="actions" id="actionButtons"></div>

    <!-- Edit Form -->
    <div class="card" id="editForm">
      <h3>Edit Profile</h3>
      <input type="file" id="editPic" accept="image/*">
      <input type="text" id="editName" placeholder="Name">
      <input type="number" id="editAge" placeholder="Age">
      <input type="text" id="editGender" placeholder="Gender">
      <input type="text" id="editIdentity" placeholder="Identity (e.g. YouTuber)">
      <input type="text" id="editAddress" placeholder="Address">
      <textarea id="editBio" placeholder="Bio"></textarea>
      <input type="text" id="editLinks" placeholder="Links (comma separated)">
      <button class="btn btn-primary" id="saveProfile">Save</button>
      <button class="btn btn-secondary" id="cancelEdit">Cancel</button>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
const firebaseConfig = {
    apiKey: "AIzaSyAJUpbCOWRl_YU14eAjARPacD9CuiBSPfg",
    authDomain: "probso.firebaseapp.com",
    projectId: "probso",
    storageBucket: "probso.firebasestorage.app",
    messagingSenderId: "892196080965",
    appId: "1:892196080965:web:9459195d61c71ed22a022c"
  };
    

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUserId = null;
    let profileUserId = null; // jis profile ko dekh rahe hain
    let newProfilePicFile = null;

    // Profile Load
    async function loadProfile(userId, isOwnProfile=false){
      profileUserId = userId;
      const ref = doc(db, "profiles", userId);
      const snap = await getDoc(ref);
      if(snap.exists()){
        const data = snap.data();
        document.getElementById("profileName").textContent = data.name || "No Name";
        document.getElementById("points").textContent = (data.points || 0) + " Points";
        document.getElementById("age").textContent = data.age || "";
        document.getElementById("gender").textContent = data.gender || "";
        document.getElementById("identity").textContent = data.identity || "";
        document.getElementById("address").textContent = data.address || "";
        document.getElementById("bio").textContent = data.bio || "";
        document.getElementById("links").innerHTML = (data.links || []).map(l=>`<a href="${l}" target="_blank">${l}</a>`).join(" | ");
        document.getElementById("profilePic").src = data.photoURL || "https://via.placeholder.com/100";
        document.getElementById("followers").textContent = data.followersCount || 0;
        document.getElementById("following").textContent = data.followingCount || 0;
      }

      // Action buttons
      const actionDiv = document.getElementById("actionButtons");
      actionDiv.innerHTML = "";
      if(isOwnProfile){
        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-primary";
        editBtn.textContent = "Edit Profile";
        editBtn.onclick = ()=> document.getElementById("editForm").style.display = "block";
        actionDiv.appendChild(editBtn);
      } else {
        const followBtn = document.createElement("button");
        followBtn.className = "btn btn-primary";
        actionDiv.appendChild(followBtn);

        // Check already following?
        const followDoc = await getDoc(doc(db, "followers", profileUserId, "userFollowers", currentUserId));
        if(followDoc.exists()){
          followBtn.textContent = "Unfollow";
          followBtn.onclick = ()=> unfollowUser();
        } else {
          followBtn.textContent = "Follow";
          followBtn.onclick = ()=> followUser();
        }
      }
    }

    // Save Profile (Edit)
    async function saveProfile(){
      let photoURL = null;
      if(newProfilePicFile){
        const storageRef = ref(storage, "profilePics/" + currentUserId);
        await uploadBytes(storageRef, newProfilePicFile);
        photoURL = await getDownloadURL(storageRef);
      }

      const ref = doc(db, "profiles", currentUserId);
      await setDoc(ref, {
        name: document.getElementById("editName").value,
        age: document.getElementById("editAge").value,
        gender: document.getElementById("editGender").value,
        identity: document.getElementById("editIdentity").value,
        address: document.getElementById("editAddress").value,
        bio: document.getElementById("editBio").value,
        links: document.getElementById("editLinks").value.split(",").map(l=>l.trim()),
        ...(photoURL && { photoURL })
      }, { merge:true });

      alert("Profile updated!");
      document.getElementById("editForm").style.display = "none";
      loadProfile(currentUserId, true);
      newProfilePicFile = null;
    }

    // Follow User
    async function followUser(){
      await setDoc(doc(db, "followers", profileUserId, "userFollowers", currentUserId), { followedAt: Date.now() });
      await setDoc(doc(db, "following", currentUserId, "userFollowing", profileUserId), { followedAt: Date.now() });

      await updateDoc(doc(db, "profiles", profileUserId), { followersCount: increment(1) });
      await updateDoc(doc(db, "profiles", currentUserId), { followingCount: increment(1) });

      loadProfile(profileUserId, false);
    }

    // Unfollow User
    async function unfollowUser(){
      await deleteDoc(doc(db, "followers", profileUserId, "userFollowers", currentUserId));
      await deleteDoc(doc(db, "following", currentUserId, "userFollowing", profileUserId));

      await updateDoc(doc(db, "profiles", profileUserId), { followersCount: increment(-1) });
      await updateDoc(doc(db, "profiles", currentUserId), { followingCount: increment(-1) });

      loadProfile(profileUserId, false);
    }

    // Auth
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUserId = user.uid;
        // Apna profile load kare
        await loadProfile(user.uid, true);
        // Note: agar dusre user ka profile dikhana ho, yahan userId change kar sakte ho
      } else {
        alert("Please login first");
      }
    });

    // Events
    document.getElementById("saveProfile").onclick = saveProfile;
    document.getElementById("cancelEdit").onclick = ()=> document.getElementById("editForm").style.display = "none";
    document.getElementById("editPic").addEventListener("change", e=>{
      newProfilePicFile = e.target.files[0];
    });
  </script>
</body>
</html>